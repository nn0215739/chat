<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pháp Đàm Trực Tuyến (MongoDB)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .scrollable-content::-webkit-scrollbar { width: 6px; }
        .scrollable-content::-webkit-scrollbar-track { background: #f1f1f1; }
        .scrollable-content::-webkit-scrollbar-thumb { background: #c19a6b; border-radius: 6px; }
        .scrollable-content::-webkit-scrollbar-thumb:hover { background: #a9885a; }
        .bg-pattern {
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23c19a6b' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
    </style>
</head>
<body class="bg-[#F5F1E9] antialiased">

    <div id="app" class="w-screen h-screen overflow-hidden">
        <!-- Các màn hình Welcome và Login giữ nguyên cấu trúc HTML -->
        <div id="welcome-screen" class="w-full h-full flex items-center justify-center bg-pattern">
             <div class="text-center p-8">
                <svg class="w-24 h-24 mx-auto text-[#D4AF37]" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 21a9 9 0 100-18 9 9 0 000 18z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 3v1m0 16v1m8.66-14.66l-.707.707M4.04 19.96l-.707.707M21 12h-1M4 12H3m14.66 8.66l-.707-.707M4.04 4.04l-.707-.707"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 12a4 4 0 100-8 4 4 0 000 8z"></path></svg>
                <h1 class="text-4xl font-bold text-[#6B4F4F] mt-6">Pháp Đàm Trực Tuyến</h1>
                <p class="text-gray-500 mt-3 max-w-md mx-auto">Nơi giải đáp các thắc mắc và chia sẻ kiến thức Phật pháp. Vui lòng chọn vai trò của bạn để tiếp tục.</p>
                <div class="mt-10 space-y-4 sm:space-y-0 sm:space-x-4 flex flex-col sm:flex-row justify-center">
                    <button id="start-chat-button" class="w-full sm:w-auto bg-[#c19a6b] text-white font-bold py-3 px-8 rounded-lg hover:bg-[#a9885a] transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#c19a6b]">Bắt đầu trò chuyện</button>
                    <button id="admin-login-prompt-button" class="w-full sm:w-auto bg-white text-[#6B4F4F] font-bold py-3 px-8 rounded-lg hover:bg-gray-100 border border-gray-300 transition-transform transform hover:scale-105">Đăng nhập Quản trị</button>
                </div>
            </div>
        </div>
        <div id="login-screen" class="hidden w-full h-full items-center justify-center bg-pattern">
            <div class="w-full max-w-sm p-8 bg-white/80 backdrop-blur-sm rounded-2xl shadow-2xl border border-gray-200">
                <div class="text-center mb-8"><h1 class="text-3xl font-bold text-[#6B4F4F] mt-4">Đăng Nhập Quản Trị</h1><p class="text-gray-500 mt-2">Chỉ dành cho quản trị viên.</p></div>
                <form id="login-form">
                    <div class="mb-4"><label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email</label><input type="email" id="email" name="email" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-[#c19a6b] focus:border-[#c19a6b] transition" placeholder="admin@example.com"></div>
                    <div class="mb-6"><label for="password" class="block text-sm font-medium text-gray-700 mb-1">Mật khẩu</label><input type="password" id="password" name="password" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-[#c19a6b] focus:border-[#c19a6b] transition" placeholder="••••••••"></div>
                    <button type="submit" class="w-full bg-[#c19a6b] text-white font-bold py-3 rounded-lg hover:bg-[#a9885a] transition-transform transform hover:scale-105">Đăng Nhập</button>
                    <p id="login-error" class="text-red-500 text-sm mt-4 text-center"></p>
                    <button type="button" id="back-to-welcome-button" class="w-full mt-4 text-sm text-gray-600 hover:text-[#c19a6b]">Quay lại</button>
                </form>
            </div>
        </div>

        <!-- Main Chat Interface -->
        <div id="chat-interface" class="hidden w-full h-full">
            <div class="flex h-full w-full">
                <!-- Admin: Chat List Panel -->
                <div id="chat-list-panel" class="hidden md:flex flex-col w-full md:w-1/3 lg:w-1/4 bg-white/60 border-r border-gray-200">
                    <div class="p-4 border-b border-gray-200"><h2 class="text-xl font-bold text-[#6B4F4F]">Các cuộc trò chuyện</h2><p class="text-sm text-gray-500">Chọn một cuộc trò chuyện để xem.</p></div>
                    <div id="chat-list-container" class="flex-grow overflow-y-auto scrollable-content"></div>
                    <div class="p-2 border-t border-gray-200"><button id="logout-button" class="w-full text-sm text-gray-600 hover:bg-gray-200 p-2 rounded-md transition">Đăng xuất</button></div>
                </div>

                <!-- Chat Window (For both User and Admin) -->
                <div id="chat-window-panel" class="flex flex-col w-full h-full bg-[#F5F1E9]">
                    <header class="flex-shrink-0 bg-white/80 backdrop-blur-sm shadow-md p-4 flex items-center justify-between border-b border-gray-200">
                        <div class="flex items-center">
                            <svg class="w-8 h-8 text-[#D4AF37]" viewBox="0 0 28 28" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M14 0C6.268 0 0 6.268 0 14s6.268 14 14 14 14-6.268 14-14S21.732 0 14 0zm0 26C7.373 26 2 20.627 2 14S7.373 2 14 2s12 5.373 12 12-5.373 12-12 12z"/><path d="M14 4c-5.523 0-10 4.477-10 10s4.477 10 10 10 10-4.477 10-10S19.523 4 14 4zm0 18c-4.418 0-8-3.582-8-8s3.582-8 8-8 8 3.582 8 8-3.582 8-8 8z"/><path d="M14 7c-3.866 0-7 3.134-7 7s3.134 7 7 7 7-3.134 7-7-3.134-7-7-7zm0 12c-2.761 0-5-2.239-5-5s2.239-5 5-5 5 2.239 5 5-2.239 5-5 5z"/></svg>
                            <h1 id="chat-header-title" class="text-xl font-bold text-[#6B4F4F] ml-3">Pháp Đàm Trực Tuyến</h1>
                        </div>
                         <button id="user-logout-button" class="text-sm text-gray-600 hover:text-[#c19a6b] transition md:hidden">Thoát</button>
                    </header>
                    <main id="messages-container" class="flex-grow p-4 md:p-6 overflow-y-auto scrollable-content">
                        <div id="messages" class="space-y-4"><div id="placeholder" class="text-center text-gray-500 mt-10"><p>Chào mừng bạn!</p><p class="text-sm">Hãy đặt câu hỏi của bạn ở khung chat bên dưới.</p><p id="admin-placeholder" class="hidden mt-4 text-sm">Vui lòng chọn một cuộc trò chuyện từ danh sách bên trái để bắt đầu.</p></div></div>
                    </main>
                    <footer id="message-footer" class="flex-shrink-0 p-4 bg-white/80 backdrop-blur-sm border-t border-gray-200">
                        <form id="message-form" class="flex items-center space-x-4">
                            <input id="message-input" type="text" placeholder="Nhập câu hỏi của bạn..." autocomplete="off" class="w-full px-4 py-3 border border-gray-300 rounded-full focus:ring-[#c19a6b] focus:border-[#c19a6b] transition">
                            <button type="submit" class="bg-[#c19a6b] text-white rounded-full p-3 hover:bg-[#a9885a] transition-transform transform hover:scale-110"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"></path></svg></button>
                        </form>
                    </footer>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        // !!! QUAN TRỌNG: Thay đổi URL này thành URL của backend server của bạn sau khi triển khai !!!
        const BACKEND_URL = "http://localhost:3000"; 

        // --- DOM ELEMENTS ---
        const welcomeScreen = document.getElementById('welcome-screen');
        const loginScreen = document.getElementById('login-screen');
        const chatInterface = document.getElementById('chat-interface');
        const chatListPanel = document.getElementById('chat-list-panel');
        const chatListContainer = document.getElementById('chat-list-container');
        const messagesContainer = document.getElementById('messages-container');
        const messagesDiv = document.getElementById('messages');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const messageFooter = document.getElementById('message-footer');
        const placeholder = document.getElementById('placeholder');
        const adminPlaceholder = document.getElementById('admin-placeholder');
        const chatHeaderTitle = document.getElementById('chat-header-title');
        
        const startChatButton = document.getElementById('start-chat-button');
        const adminLoginPromptButton = document.getElementById('admin-login-prompt-button');
        const backToWelcomeButton = document.getElementById('back-to-welcome-button');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const logoutButton = document.getElementById('logout-button');
        const userLogoutButton = document.getElementById('user-logout-button');

        // --- STATE MANAGEMENT ---
        let socket;
        let isAdmin = false;
        let currentUserId = localStorage.getItem('chatUserId');
        let currentRoomId = null;
        const originalTitle = document.title;
        const notificationSound = new Tone.Synth().toDestination();

        // --- INITIALIZATION ---
        function initializeSocketConnection() {
            // Disconnect previous socket if exists
            if (socket) {
                socket.disconnect();
            }
            socket = io(BACKEND_URL);
            setupSocketListeners();
        }

        // --- SCREEN & UI NAVIGATION ---
        function showScreen(screen) {
            [welcomeScreen, loginScreen, chatInterface].forEach(s => s.classList.add('hidden'));
            screen.classList.remove('hidden');
            screen.classList.add('flex');
        }

        startChatButton.addEventListener('click', () => {
            if (!currentUserId) {
                currentUserId = 'user_' + Date.now() + Math.random().toString(36).substring(2, 9);
                localStorage.setItem('chatUserId', currentUserId);
            }
            isAdmin = false;
            initializeSocketConnection();
            showScreen(chatInterface);
            setupUserView(currentUserId);
        });

        adminLoginPromptButton.addEventListener('click', () => showScreen(loginScreen));
        backToWelcomeButton.addEventListener('click', () => showScreen(welcomeScreen));
        
        const handleLogout = () => {
            localStorage.removeItem('adminToken');
            localStorage.removeItem('chatUserId');
            isAdmin = false;
            currentUserId = null;
            if (socket) socket.disconnect();
            showScreen(welcomeScreen);
        };
        logoutButton.addEventListener('click', handleLogout);
        userLogoutButton.addEventListener('click', handleLogout);

        // --- AUTH & VIEW SETUP ---
        loginForm.addEventListener('submit', async e => {
            e.preventDefault();
            loginError.textContent = '';
            const email = loginForm.email.value;
            const password = loginForm.password.value;
            
            try {
                const response = await fetch(`${BACKEND_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                if (!response.ok) throw new Error('Login failed');
                const { token } = await response.json();
                localStorage.setItem('adminToken', token);
                isAdmin = true;
                initializeSocketConnection();
                showScreen(chatInterface);
                setupAdminView();
            } catch (err) {
                loginError.textContent = "Sai email hoặc mật khẩu.";
            }
        });

        function setupAdminView() {
            chatListPanel.classList.remove('hidden');
            chatListPanel.classList.add('md:flex');
            adminPlaceholder.classList.remove('hidden');
            placeholder.classList.add('hidden');
            messageFooter.classList.add('hidden');
            chatHeaderTitle.textContent = "Bảng điều khiển";
            socket.emit('admin:join');
        }

        function setupUserView(userId) {
            currentRoomId = userId;
            chatListPanel.classList.add('hidden');
            adminPlaceholder.classList.add('hidden');
            placeholder.classList.remove('hidden');
            messageFooter.classList.remove('hidden');
            chatHeaderTitle.textContent = "Pháp Đàm Trực Tuyến";
            socket.emit('user:join', userId);
        }

        // --- SOCKET.IO LISTENERS ---
        function setupSocketListeners() {
            socket.on('connect', () => {
                console.log('Connected to server with ID:', socket.id);
                // Re-join room if user refreshes
                const token = localStorage.getItem('adminToken');
                if (token) {
                    isAdmin = true;
                    setupAdminView();
                } else if (currentUserId) {
                    isAdmin = false;
                    setupUserView(currentUserId);
                }
            });

            socket.on('chatList', renderChatRoomList);
            socket.on('roomMessages', renderMessages);
            socket.on('newMessage', (message) => {
                if (message.roomId === currentRoomId) {
                    appendMessage(message);
                    scrollToBottom();
                }
                if (document.hidden) {
                    document.title = `(Mới) ${originalTitle}`;
                    notificationSound.triggerAttackRelease("C5", "8n");
                }
            });
        }

        // --- ADMIN: CHAT ROOM LIST ---
        function renderChatRoomList(rooms) {
            chatListContainer.innerHTML = '';
            if (rooms.length === 0) {
                chatListContainer.innerHTML = `<p class="p-4 text-center text-gray-500">Chưa có cuộc trò chuyện nào.</p>`;
            } else {
                rooms.forEach(renderChatRoomItem);
            }
        }

        function renderChatRoomItem(room) {
            const item = document.createElement('div');
            item.className = `p-4 border-b border-gray-200 cursor-pointer hover:bg-[#f5f1e9] transition ${room._id === currentRoomId ? 'bg-[#e6dacb]' : ''}`;
            item.dataset.roomId = room._id;

            const lastMessageTime = room.timestamp ? new Date(room.timestamp).toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' }) : '';
            
            item.innerHTML = `
                <div class="flex justify-between items-center">
                    <p class="font-bold text-sm truncate text-[#6B4F4F]">User: ${room._id.substring(0, 12)}</p>
                    <p class="text-xs text-gray-500">${lastMessageTime}</p>
                </div>
                <div class="flex justify-between items-start mt-1">
                    <p class="text-sm text-gray-600 truncate pr-2">${room.lastMessage || '...'}</p>
                    ${room.hasUnreadAdmin ? '<span class="w-3 h-3 bg-red-500 rounded-full flex-shrink-0"></span>' : ''}
                </div>
            `;
            item.addEventListener('click', () => {
                currentRoomId = room._id;
                socket.emit('admin:viewRoom', room._id);
                chatHeaderTitle.textContent = `Trò chuyện với User ${room._id.substring(0, 12)}`;
                messageFooter.classList.remove('hidden');
                document.querySelectorAll('#chat-list-container > div').forEach(el => {
                    el.classList.toggle('bg-[#e6dacb]', el.dataset.roomId === room._id);
                });
            });
            chatListContainer.appendChild(item);
        }

        // --- CORE CHAT LOGIC ---
        function renderMessages(messages) {
            messagesDiv.innerHTML = '';
            if (messages.length === 0) {
                placeholder.classList.remove('hidden');
            } else {
                placeholder.classList.add('hidden');
                messages.forEach(appendMessage);
            }
            scrollToBottom();
        }

        messageForm.addEventListener('submit', e => {
            e.preventDefault();
            const text = messageInput.value.trim();
            if (!text || !currentRoomId || !socket) return;
            
            socket.emit('sendMessage', {
                roomId: currentRoomId,
                senderId: isAdmin ? 'admin' : currentUserId,
                text,
                isAdmin
            });
            messageInput.value = '';
        });

        function appendMessage(msg) {
            placeholder.classList.add('hidden');
            const wrapper = document.createElement('div');
            const bubble = document.createElement('div');
            const time = document.createElement('div');

            wrapper.classList.add('flex', 'flex-col');
            bubble.classList.add('max-w-xs', 'md:max-w-md', 'lg:max-w-lg', 'px-4', 'py-2', 'rounded-2xl', 'break-words');
            time.classList.add('text-xs', 'text-gray-500', 'mt-1');

            const msgDate = msg.timestamp ? new Date(msg.timestamp) : new Date();
            time.textContent = msgDate.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });

            if (msg.isAdmin) {
                wrapper.classList.add('items-end');
                bubble.classList.add('bg-[#c19a6b]', 'text-white');
                time.classList.add('text-right');
            } else {
                wrapper.classList.add('items-start');
                bubble.classList.add('bg-white', 'shadow-sm');
                time.classList.add('text-left');
            }

            bubble.textContent = msg.text;
            wrapper.appendChild(bubble);
            wrapper.appendChild(time);
            messagesDiv.appendChild(wrapper);
        }

        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                document.title = originalTitle;
            }
        });
        
        // Check for existing session on page load
        const adminToken = localStorage.getItem('adminToken');
        if(adminToken) {
             isAdmin = true;
             initializeSocketConnection();
             showScreen(chatInterface);
             setupAdminView();
        } else if (currentUserId) {
             isAdmin = false;
             initializeSocketConnection();
             showScreen(chatInterface);
             setupUserView(currentUserId);
        } else {
            showScreen(welcomeScreen);
        }

    </script>
</body>
</html>
