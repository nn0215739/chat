<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PHÁP MÔN TÂM LINH - KẾT NỐI CỘNG ĐỒNG</title>
	<link id="favicon" rel="icon" href="/favicon.ico" type="image/x-icon">
	<link href="/dist/output.css" rel="stylesheet">
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html, body {
            height: 100%;
            overflow: hidden;
        }
        body {
            font-family: 'Inter', sans-serif;
        }
        .scrollable-content::-webkit-scrollbar { width: 6px; }
        .scrollable-content::-webkit-scrollbar-track { background: #f1f1f1; }
        .scrollable-content::-webkit-scrollbar-thumb { background: #c19a6b; border-radius: 6px; }
        .scrollable-content::-webkit-scrollbar-thumb:hover { background: #a9885a; }
        .bg-pattern {
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23c19a6b' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
		/* --- THÊM MỚI: CSS CHO ẢNH --- */
        .chat-image { 
            max-width: 100%; 
            border-radius: 8px; 
            margin-top: 5px; 
            cursor: pointer; 
            border: 1px solid rgba(0,0,0,0.1); 
        }
        .chat-image:hover { opacity: 0.9; }
        
        /* Khung xem trước ảnh khi chọn */
        #image-preview-container { 
            position: absolute; 
            bottom: 80px; 
            left: 20px; 
            right: 20px; 
            background: white; 
            padding: 10px; 
            border-radius: 10px; 
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1); 
            display: none; 
            z-index: 30; 
        }
        #image-preview { 
            max-height: 150px; 
            border-radius: 5px; 
            display: block; 
            margin: 0 auto; 
        }
        #remove-image { 
            position: absolute; 
            top: 5px; 
            right: 5px; 
            background: red; 
            color: white; 
            border-radius: 50%; 
            width: 24px; 
            height: 24px; 
            text-align: center; 
            line-height: 24px; 
            cursor: pointer; 
            font-weight: bold; 
        }
    </style>
</head>
<body class="bg-[#fffbbe] antialiased">
    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm mx-4">
            <h3 id="confirmation-title" class="text-lg font-bold text-gray-800">Xác nhận hành động</h3>
            <p id="confirmation-message" class="text-gray-600 mt-2">Bạn có chắc chắn muốn xóa toàn bộ cuộc hội thoại này không? Hành động này không thể hoàn tác.</p>
            <div class="mt-6 flex justify-end space-x-4">
                <button id="confirm-cancel-button" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Hủy bỏ</button>
                <button id="confirm-action-button" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Xác nhận Xóa</button>
            </div>
        </div>
    </div>

    <div id="toast-container" class="fixed top-5 right-5 z-40 w-full max-w-xs space-y-2"></div>

    <div id="app" class="w-full h-full flex flex-col">
        <!-- Welcome Screen -->
        <div id="welcome-screen" class="w-full h-full flex items-center justify-center bg-pattern p-4">
             <div class="text-center p-6 bg-white/80 backdrop-blur-sm rounded-2xl shadow-2xl border border-gray-200 mx-auto max-w-md">
                <img src="logo.png" alt="Logo Pháp Môn Tâm Linh" class="w-20 h-20 mx-auto mb-4 object-contain" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
                <div style="display:none;" class="w-20 h-20 mx-auto mb-4 bg-gray-200 rounded-full flex items-center justify-center text-gray-500">Logo</div>

                <h1 class="text-2xl font-bold text-[#6B4F4F] leading-tight">
                    PHÁP MÔN TÂM LINH
                    <br>
                    <span class="text-2xl">Chia Sẻ & Kết Nối</span>
                </h1>
                <p class="text-gray-500 mt-2 text-sm">https://hotro.pmtl.site | https://chat.pmtl.site</p>
                <div class="mt-6 w-full max-w-xs mx-auto">
                    <label for="display-name-input" class="block text-sm font-medium text-gray-700 mb-1 text-left">Nhập Email của Sư huynh:</label>
                    <input id="display-name-input" type="text" placeholder="Ví dụ: abc@gmail.com" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-[#c19a6b] focus:border-[#c19a6b] transition">
                </div>
                <div class="mt-4 space-y-3 flex flex-col items-center">
                    <button id="start-chat-button" class="w-full max-w-xs bg-[#c19a6b] text-white font-bold py-3 px-6 rounded-lg hover:bg-[#a9885a] transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#c19a6b]">Bắt đầu trò chuyện</button>
                </div>
                <div class="mt-8 text-center">
                    <button id="admin-login-prompt-button" class="text-xs text-gray-500 hover:text-[#c19a6b] hover:underline">Đăng nhập với tư cách Quản trị viên</button>
                </div>
             </div>
        </div>

        <!-- Login Screen -->
        <div id="login-screen" class="hidden w-full h-full items-center justify-center bg-pattern p-4">
             <div class="w-full max-w-sm p-8 bg-white/80 backdrop-blur-sm rounded-2xl shadow-2xl border border-gray-200">
                <div class="text-center mb-8"><h1 class="text-3xl font-bold text-[#6B4F4F] mt-4">Đăng Nhập Quản Trị</h1><p class="text-gray-500 mt-2">Chỉ dành cho quản trị viên.</p></div>
                <form id="login-form">
					<div class="mb-4">
						<label for="email" ...>Email</label>
						<input type="email" id="email" name="email" required autocomplete="email" class="..." placeholder="admin@example.com">
					</div>
					<div class="mb-6">
						<label for="password" ...>Mật khẩu</label>
						<input type="password" id="password" name="password" required autocomplete="current-password" class="..." placeholder="••••••••">
					</div>                    <button type="submit" class="w-full bg-[#c19a6b] text-white font-bold py-3 rounded-lg hover:bg-[#a9885a] transition-transform transform hover:scale-105">Đăng Nhập</button>
                    <p id="login-error" class="text-red-500 text-sm mt-4 text-center"></p>
                    <button type="button" id="back-to-welcome-button" class="w-full mt-4 text-sm text-gray-600 hover:text-[#c19a6b]">Quay lại</button>
                </form>
            </div>
        </div>

        <!-- Chat Interface -->
        <div id="chat-interface" class="hidden h-full w-full flex-grow flex md:flex-row">
            <!-- Admin: Chat List Panel -->
            <div id="chat-list-panel" class="hidden md:flex flex-col w-full md:w-1/3 lg:w-1/4 bg-white border-r border-gray-200">
                <div class="p-4 border-b border-gray-200 flex items-center justify-between flex-shrink-0">
                    <div>
                        <h2 class="text-xl font-bold text-[#6B4F4F]">DANH SÁCH TIN NHẮN</h2>
                        <p class="text-sm text-gray-500">Danh sách tin nhắn của đồng tu.</p>
                    </div>
                </div>
                <div id="online-admins-panel" class="hidden p-4 border-b border-gray-200 flex-shrink-0 bg-gray-50">
                    <h3 class="text-sm font-bold text-[#6B4F4F] mb-2">QUẢN TRỊ VIÊN ONLINE</h3>
                    <ul id="online-admins-list" class="space-y-2">
                        <!-- Danh sách admin sẽ được JS chèn vào đây -->
                    </ul>
                </div>
                <div id="chat-list-container" class="flex-grow overflow-y-auto scrollable-content"></div>
                <div class="p-2 border-t border-gray-200 flex-shrink-0"><button id="logout-button" class="w-full text-sm text-gray-600 hover:bg-gray-200 p-2 rounded-md transition">Đăng xuất</button></div>
            </div>

            <!-- Chat Window (For both User and Admin) -->
            <div id="chat-window-panel" class="hidden md:flex flex-col w-full h-full bg-[#F5F1E9]">
                <header class="flex-shrink-0 bg-white/80 backdrop-blur-sm shadow-md p-3 flex items-center justify-between border-b border-gray-200">
                    <div class="flex items-center flex-1 min-w-0">
                        <button id="open-chat-list-button" class="md:hidden mr-2 text-gray-600 hover:text-[#c19a6b]">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                        </button>
                        <svg class="w-8 h-8 text-[#D4AF37] hidden sm:block" viewBox="0 0 28 28" fill="currentColor"><path d="M14 0C6.268 0 0 6.268 0 14s6.268 14 14 14 14-6.268 14-14S21.732 0 14 0zm0 26C7.373 26 2 20.627 2 14S7.373 2 14 2s12 5.373 12 12-5.373 12-12 12z"/><path d="M14 4c-5.523 0-10 4.477-10 10s4.477 10 10 10 10-4.477 10-10S19.523 4 14 4zm0 18c-4.418 0-8-3.582-8-8s3.582-8 8-8 8 3.582 8 8-3.582 8-8 8z"/><path d="M14 7c-3.866 0-7 3.134-7 7s3.134 7 7 7 7-3.134 7-7-3.134-7-7-7zm0 12c-2.761 0-5-2.239-5-5s2.239-5 5-5 5 2.239 5 5-2.239 5-5 5z"/></svg>
                        <h1 id="chat-header-title" class="text-lg font-bold text-[#6B4F4F] ml-2 truncate">Hỗ Trợ Trực Tuyến</h1>
                    </div>
                    <div class="flex items-center space-x-2 flex-shrink-0 ml-2">
                         <button id="delete-conversation-button" class="hidden items-center space-x-2 bg-red-600 text-white font-bold py-2 px-3 rounded-lg hover:bg-red-700 transition" title="Xóa toàn bộ hội thoại">
                            <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                            </svg>
                            <span class="hidden sm:inline">Xóa Hội thoại</span>
                        </button>
                         <button id="lock-chat-button" class="hidden items-center space-x-2 bg-yellow-500 text-white font-bold py-2 px-3 rounded-lg hover:bg-yellow-600 transition">
                            <svg id="lock-icon" class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 1a4.5 4.5 0 00-4.5 4.5V9H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-.5V5.5A4.5 4.5 0 0010 1zm3 8V5.5a3 3 0 10-6 0V9h6z" clip-rule="evenodd" /></svg>
                             <svg id="unlock-icon" class="w-4 h-4 hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a5 5 0 00-5 5v1h-1a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-1V7a5 5 0 00-5-5zm2.5 7.5V7a2.5 2.5 0 00-5 0v.5h5z" fill-rule="evenodd" clip-rule="evenodd" /></svg>
                            <span id="lock-chat-text" class="hidden sm:inline">Khoá</span>
                        </button>
                         <button id="user-logout-button" class="hidden md:block text-sm text-gray-600 hover:text-[#c19a6b] transition">Đăng Xuất</button>
                    </div>
                </header>
                <main id="messages-container" class="flex-grow p-4 md:p-6 overflow-y-auto scrollable-content">
                    <div id="messages" class="space-y-4">
                        <div id="placeholder" class="text-center text-gray-500 mt-10">
                            <p>Chào mừng bạn!</p>
                            <p class="text-sm">Hãy đặt câu hỏi của bạn ở khung chat bên dưới.</p>
                            <p id="admin-placeholder" class="hidden mt-4 text-sm">Vui lòng chọn một cuộc trò chuyện từ danh sách bên trái.</p>
                        </div>
                    </div>
					<div id="image-preview-container">
	                    <div id="remove-image">×</div>
	                    <img id="image-preview" src="" alt="Preview">
	                </div>
                </main>
                <footer id="message-footer" class="flex-shrink-0 p-4 bg-white/80 backdrop-blur-sm border-t border-gray-200">
					<form id="message-form" class="flex items-center space-x-4">
						<label for="image-input" class="cursor-pointer text-gray-500 hover:text-[#c19a6b] p-2">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
                            </svg>
                        </label>
                        <input type="file" id="image-input" accept="image/*" class="hidden">
                        <input id="message-input" type="text" placeholder="Nhập câu hỏi của bạn..." autocomplete="off" class="w-full px-4 py-3 border border-gray-300 rounded-full focus:ring-[#c19a6b] focus:border-[#c19a6b] transition disabled:bg-gray-200">
                        <button type="submit" id="send-message-button" class="bg-[#c19a6b] text-white rounded-full p-3 hover:bg-[#a9885a] transition-transform transform hover:scale-110 disabled:bg-gray-400 disabled:transform-none disabled:cursor-not-allowed flex items-center justify-center">
                            <svg id="send-icon" class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"></path></svg>
                            <div id="loading-spinner" class="hidden animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                        </button>
                    </form>
                </footer>
            </div>
        </div>
    </div>
	<div id="image-modal" class="hidden fixed inset-0 z-[9999] bg-black/95 flex items-center justify-center p-4 transition-opacity duration-300 backdrop-blur-sm" onclick="this.classList.add('hidden')">
	        <img id="full-size-image" src="" class="max-w-full max-h-full object-contain rounded-lg shadow-2xl transition-transform duration-300 scale-100">
	        <button class="absolute top-6 right-6 text-white/80 hover:text-white text-5xl font-bold cursor-pointer focus:outline-none">&times;</button>
	</div>
    <script>
        // --- CONFIGURATION ---
        const BACKEND_URL = "https://chat-t1ar.onrender.com";
        const VAPID_PUBLIC_KEY = "BLR3ESERJvSd663nWEkEVoQHkfIk6V0akO8_lVv8Tl4ATq3TNJc2wZQQUYajbRUN0rXreHPDA5As_OMOMN8e4Ms";
        const ADMIN_ONLY_ROOM_ID = 'admins_only_chat';

        // --- DOM ELEMENTS ---
        const welcomeScreen = document.getElementById('welcome-screen');
        const startChatButton = document.getElementById('start-chat-button');
        const displayNameInput = document.getElementById('display-name-input');
        const appDiv = document.getElementById('app');
        const loginScreen = document.getElementById('login-screen');
        const chatInterface = document.getElementById('chat-interface');
        const chatListPanel = document.getElementById('chat-list-panel');
        const chatListContainer = document.getElementById('chat-list-container');
        const chatWindowPanel = document.getElementById('chat-window-panel');
        const messagesContainer = document.getElementById('messages-container');
        const messagesDiv = document.getElementById('messages');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const messageFooter = document.getElementById('message-footer');
        const placeholder = document.getElementById('placeholder');
        const adminPlaceholder = document.getElementById('admin-placeholder');
        const chatHeaderTitle = document.getElementById('chat-header-title');
        const adminLoginPromptButton = document.getElementById('admin-login-prompt-button');
        const backToWelcomeButton = document.getElementById('back-to-welcome-button');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const logoutButton = document.getElementById('logout-button');
        const userLogoutButton = document.getElementById('user-logout-button');
        const openChatListButton = document.getElementById('open-chat-list-button');
        const lockChatButton = document.getElementById('lock-chat-button');
        const lockChatText = document.getElementById('lock-chat-text');
        const lockIcon = document.getElementById('lock-icon');
        const unlockIcon = document.getElementById('unlock-icon');
        const deleteConversationButton = document.getElementById('delete-conversation-button');
        const sendMessageButton = document.getElementById('send-message-button');
        const sendIcon = document.getElementById('send-icon');
        const loadingSpinner = document.getElementById('loading-spinner');
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmationTitle = document.getElementById('confirmation-title');
        const confirmationMessage = document.getElementById('confirmation-message');
        const confirmCancelButton = document.getElementById('confirm-cancel-button');
        const confirmActionButton = document.getElementById('confirm-action-button');
        const installPromptContainer = document.getElementById('install-prompt-container');
        const installButton = document.getElementById('install-button');
        const closeInstallPrompt = document.getElementById('close-install-prompt');
        const onlineAdminsPanel = document.getElementById('online-admins-panel');


        // --- STATE MANAGEMENT ---
        let socket;
        let isAdmin = false;
        let currentUserId = localStorage.getItem('chatUserId');
        let displayName = localStorage.getItem('chatDisplayName');
        let adminDisplayName = localStorage.getItem('adminDisplayName'); 
        let adminEmail = localStorage.getItem('adminEmail');
        let currentRoomId = null;
        let isCurrentChatLocked = false;
        const originalTitle = document.title;
        let confirmActionCallback = null;
        let deferredInstallPrompt = null;
		let backButtonPressedOnce = false;
        
        // --- TONE.JS INITIALIZATION ---
        const notificationSynth = new Tone.Synth().toDestination();
		
		// --- THÊM CÁC BIẾN MỚI ---
        const imageInput = document.getElementById('image-input');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        const removeImageBtn = document.getElementById('remove-image');
        const imageModal = document.getElementById('image-modal');
        const fullSizeImage = document.getElementById('full-size-image');
        let selectedImageBase64 = null; // Biến lưu ảnh đã chọn

		// --- LOGIC XỬ LÝ ẢNH (Nén & Giữ trong suốt PNG) ---
        imageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            // Lấy loại file gốc
            const fileType = file.type;

            // Giới hạn file 5MB
            if (file.size > 5 * 1024 * 1024) { 
                showToastNotification({ title: "Lỗi", text: "Ảnh quá lớn (>5MB)." }, 'error'); 
                return; 
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    let width = img.width; 
                    let height = img.height;
                    const maxSize = 800; // Kích thước tối đa sau khi nén
                    
                    // Logic Resize
                    if (width > height) { 
                        if (width > maxSize) { height *= maxSize / width; width = maxSize; } 
                    } else { 
                        if (height > maxSize) { width *= maxSize / height; height = maxSize; } 
                    }
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    
                    // Nếu file gốc là PNG, đảm bảo canvas có nền trong suốt
                    if (fileType === 'image/png') {
                        ctx.fillStyle = 'rgba(0, 0, 0, 0)'; // Đảm bảo nền trong suốt
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                    }
                    
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Định dạng đầu ra: Giữ PNG nếu là PNG gốc, còn lại dùng JPEG
                    const outputType = (fileType === 'image/png') ? 'image/png' : 'image/jpeg';
                    
                    // Nén và chuyển thành Base64
                    selectedImageBase64 = canvas.toDataURL(outputType, 0.7);
                    
                    // --- KIỂM TRA BASE64 CUỐI CÙNG (Dù đã nén nhưng vẫn kiểm tra) ---
                    if (selectedImageBase64.length > 2 * 1024 * 1024) { 
                        showToastNotification({ title: "Lỗi", text: "Ảnh quá lớn sau khi nén." }, 'error'); 
                        selectedImageBase64 = null;
                        return;
                    }
                    
                    // Hiện preview
                    imagePreview.src = selectedImageBase64;
                    imagePreviewContainer.style.display = 'block';
                }
                img.src = event.target.result;
            }
            reader.readAsDataURL(file);
        });

        removeImageBtn.addEventListener('click', () => {
            selectedImageBase64 = null;
            imageInput.value = '';
            imagePreviewContainer.style.display = 'none';
        });
		
		function showCustomConfirmationModal({ title, message, confirmText, confirmClass = 'bg-red-600', onConfirm }) {
            confirmationTitle.textContent = title;
            confirmationMessage.textContent = message;
            confirmActionButton.textContent = confirmText;
            
			const hoverClass = `hover:${confirmClass.replace('500', '700').replace('600', '700')}`;
			confirmActionButton.className = `px-4 py-2 text-white rounded-lg ${confirmClass} ${hoverClass}`;
            confirmActionCallback = onConfirm;
            confirmationModal.classList.remove('hidden');
        }

        function hideConfirmationModal() {
            confirmationModal.classList.add('hidden');
            confirmActionCallback = null;
        }

		function linkify(text, forAdminBubble = false) {
		            const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
		            const tempDiv = document.createElement('div');
		            tempDiv.textContent = text;
		            const sanitizedText = tempDiv.innerHTML;
		            
		            return sanitizedText.replace(urlRegex, function(url) {
		                // SỬA CLASS TẠI ĐÂY:
		                const linkClass = forAdminBubble 
		                    // Nếu là Admin (Nền tối) -> Dùng Vàng tươi, Bỏ gạch chân (no-underline)
		                    ? 'text-yellow-300 hover:text-white no-underline font-bold break-all' 
		                    // Nếu là User (Nền trắng) -> Dùng Vàng đồng, Bỏ gạch chân (no-underline)
		                    : 'text-[#c19a6b] hover:text-[#a9885a] no-underline font-bold break-all';
		                
		                return `<a href="${url}" target="_blank" rel="noopener noreferrer" class="${linkClass}">${url}</a>`;
		            });
		}

        function showToastNotification(message, type = 'info') {
            const toastContainer = document.getElementById('toast-container');
            const toastId = 'toast-' + Date.now();
            const toast = document.createElement('div');
            toast.id = toastId;
            toast.className = 'flex items-center gap-3 p-4 bg-white rounded-xl shadow-lg border border-gray-200 transform transition-all duration-500 translate-x-full opacity-0';

            let iconSvg;
            if (type === 'success') {
                iconSvg = `<svg class="w-6 h-6 text-green-500 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
            } else if (type === 'error') {
                iconSvg = `<svg class="w-6 h-6 text-red-500 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.174 3.35 1.9 3.35h13.713c1.726 0 2.766-1.85 1.9-3.35L13.737 3.376c-.863-1.5-3.033-1.5-3.896 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>`;
            }
            else {
                iconSvg = `<svg class="w-6 h-6 text-[#6B4F4F] flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
            }

            const contentDiv = document.createElement('div');
            const title = document.createElement('p');
            title.className = 'font-bold text-sm text-[#6B4F4F]';
            title.textContent = message.title;
            const text = document.createElement('p');
            text.className = 'text-sm text-gray-600';
            text.textContent = message.text.length > 50 ? message.text.substring(0, 50) + '...' : message.text;
            contentDiv.appendChild(title);
            contentDiv.appendChild(text);
            toast.innerHTML = iconSvg;
            toast.appendChild(contentDiv);
            toastContainer.appendChild(toast);

            setTimeout(() => {
                toast.classList.remove('translate-x-full', 'opacity-0');
            }, 10);
            setTimeout(() => {
                const toastToRemove = document.getElementById(toastId);
                if (toastToRemove) {
                    toastToRemove.classList.add('translate-x-full', 'opacity-0');
                    toastToRemove.addEventListener('transitionend', () => toastToRemove.remove());
                }
            }, 4000);
        }

        function showSendingState(isSending) {
            if (isSending) {
                sendMessageButton.disabled = true;
                sendIcon.classList.add('hidden');
                loadingSpinner.classList.remove('hidden');
            } else {
                if (!isCurrentChatLocked && !messageInput.disabled) {
                    sendMessageButton.disabled = false;
                }
                sendIcon.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
            }
        }

        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }
        
        async function askPermissionAndSubscribe() {
            if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
                return;
            }

            try {
                const permissionResult = await Notification.requestPermission();
                if (permissionResult !== 'granted') {
                    if (permissionResult === 'denied') {
                         showToastNotification({
                            title: "Thông Báo Bị Chặn",
                            text: "Bạn đã chặn thông báo. Vui lòng bật lại trong cài đặt trang web của trình duyệt."
                        }, 'error');
                    }
                    return;
                }

                const swRegistration = await navigator.serviceWorker.ready;
                let subscription = await swRegistration.pushManager.getSubscription();

                if (subscription === null) {
                    subscription = await swRegistration.pushManager.subscribe({
                        userVisibleOnly: true,
                        applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
                    });
                }
                
                const endpoint = isAdmin ? '/api/save-admin-subscription' : '/api/save-subscription';
                const body = isAdmin ? { subscription } : { subscription, roomId: currentUserId };

                await fetch(`${BACKEND_URL}${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

            } catch (error) {
                console.error('Failed to subscribe the user for push notifications: ', error);
            }
        }

		function playNewMessageSound() {
		    if (Tone.context.state === 'running') {
		        try {
		            notificationSynth.triggerAttackRelease("C5", "8n");
		        } catch (e) {
		            console.error("Could not play notification sound:", e);
		        }
		    }
		}

        function showScreen(screen) {
            [welcomeScreen, loginScreen, chatInterface].forEach(s => s.classList.add('hidden'));
            screen.classList.remove('hidden');
            screen.classList.add('flex');
        }

        function showChatList() {
            chatListPanel.classList.remove('hidden');
            chatListPanel.classList.add('flex');
            chatWindowPanel.classList.add('hidden');
            if (window.innerWidth >= 768) {
                chatWindowPanel.classList.remove('hidden');
                chatWindowPanel.classList.add('flex');
            }
        }

        function showChatWindow() {
            chatWindowPanel.classList.remove('hidden');
            chatWindowPanel.classList.add('flex');
            if (window.innerWidth < 768) {
                chatListPanel.classList.add('hidden');
            }
        }

        function resetChatWindow() {
            messagesDiv.innerHTML = '';
            adminPlaceholder.classList.remove('hidden');
            placeholder.classList.add('hidden');
            messageFooter.classList.add('hidden');
            chatHeaderTitle.textContent = "NỘI DUNG HỘI THOẠI";
            updateAdminControls(false);
            currentRoomId = null;
        }

        confirmActionButton.addEventListener('click', () => {
            if (typeof confirmActionCallback === 'function') {
                confirmActionCallback();
            }
            hideConfirmationModal();
        });
        confirmCancelButton.addEventListener('click', hideConfirmationModal);


		function initializeSocketConnection() {
		            const adminToken = localStorage.getItem('adminToken'); // Lấy token
		            
		            if (socket) socket.disconnect(); 
		            
		            // Khởi tạo Socket.io và gửi token ngay trong phần auth
		            socket = io(BACKEND_URL, {
		                reconnection: true, 
		                transports: ['websocket'],
		                auth: { 
		                    token: adminToken 
		                }
		            });
		            setupSocketListeners();
		}

		startChatButton.addEventListener('click', async () => {
            // 1. LƯU THÔNG TIN NGƯỜI DÙNG (Làm trước)
            displayName = displayNameInput.value.trim() || 'Sư Huynh Vô Danh';
            localStorage.setItem('chatDisplayName', displayName);
            
            if (!currentUserId) {
                currentUserId = 'user_' + Date.now() + Math.random().toString(36).substring(2, 9);
                localStorage.setItem('chatUserId', currentUserId);
            }

            // 2. CHUYỂN GIAO DIỆN NGAY LẬP TỨC (QUAN TRỌNG NHẤT)
            // Đưa các dòng này lên trước các lệnh 'await' để người dùng không bị kẹt
            isAdmin = false;
            initializeSocketConnection(); // Kết nối socket
            showScreen(chatInterface);    // Hiện màn hình chat
            setupUserView();              // Cài đặt giao diện user

            // 3. XỬ LÝ CÁC TÁC VỤ NỀN (Âm thanh & Thông báo)
            // Để xuống cuối và xử lý lỗi (catch) để không làm treo app
            
            // Kích hoạt Tone.js
            if (typeof Tone !== 'undefined' && Tone.context.state !== 'running') {
                Tone.start().catch(e => console.warn("Không thể khởi động âm thanh:", e));
            }

            // Xin quyền thông báo (Chạy ngầm, không dùng await chặn dòng chảy)
            askPermissionAndSubscribe().catch(err => console.warn("Chưa cấp quyền thông báo:", err));
        });

        adminLoginPromptButton.addEventListener('click', () => showScreen(loginScreen));
        backToWelcomeButton.addEventListener('click', () => showScreen(welcomeScreen));

        const handleLogout = (confirmFirst = false) => {
            const performLogout = () => {
                localStorage.clear();
                window.location.reload();
            };

            if (confirmFirst && !isAdmin) {
                showCustomConfirmationModal({
                    title: "Xác nhận Đăng Xuất",
                    message: "Sau khi Đăng Xuất, Sư Huynh sẽ không còn nhận được tin nhắn của Quản Trị Viên nữa ạ!",
                    confirmText: "Đăng Xuất",
                    confirmClass: 'bg-orange-500',
                    onConfirm: performLogout
                });
            } else {
                performLogout();
            }
        };
        
        logoutButton.addEventListener('click', () => handleLogout(false));
        
        userLogoutButton.addEventListener('click', () => handleLogout(true));


        openChatListButton.addEventListener('click', showChatList);

        loginForm.addEventListener('submit', async e => {
            e.preventDefault();
            try {
                const response = await fetch(`${BACKEND_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: loginForm.email.value, password: loginForm.password.value })
                });
                if (!response.ok) throw new Error('Login failed');
                const { token, displayName, email } = await response.json();
                localStorage.setItem('adminToken', token);
                localStorage.setItem('adminDisplayName', displayName);
                localStorage.setItem('adminEmail', email);
                adminDisplayName = displayName;
                adminEmail = email;
                isAdmin = true;
                initializeSocketConnection();
                showScreen(chatInterface);
            } catch (err) {
                loginError.textContent = "Sai email hoặc mật khẩu.";
            }
        });
        
        function setupAdminView() {
            chatListPanel.classList.remove('hidden');
            chatListPanel.classList.add('flex');
            onlineAdminsPanel.classList.remove('hidden');
            chatWindowPanel.classList.add('hidden');
            if (window.innerWidth >= 768) {
                chatWindowPanel.classList.remove('hidden');
                chatWindowPanel.classList.add('flex');
            }
            adminPlaceholder.classList.remove('hidden');
            placeholder.classList.add('hidden');
            messageFooter.classList.add('hidden');
            chatHeaderTitle.textContent = "NỘI DUNG HỘI THOẠI";
            updateAdminControls(false);
            openChatListButton.classList.remove('hidden');
            userLogoutButton.classList.add('hidden');
            
            socket.emit('admin:join', { displayName: adminDisplayName, email: adminEmail });

            askPermissionAndSubscribe(); 
        }

        function setupUserView() {
            showChatWindow();
            chatListPanel.classList.add('hidden');
            onlineAdminsPanel.classList.add('hidden');
            adminPlaceholder.classList.add('hidden');
            placeholder.classList.remove('hidden');
            messageFooter.classList.remove('hidden');
            chatHeaderTitle.textContent = `${displayName}`;
            openChatListButton.classList.add('hidden');
            userLogoutButton.classList.remove('hidden');
            updateAdminControls(false);
            currentRoomId = currentUserId;
            socket.emit('user:join', { userId: currentUserId, displayName: displayName });
        }

        function setupSocketListeners() {
            socket.on('connect', () => {
                const token = localStorage.getItem('adminToken');
                if (token && isAdmin) {
                    setupAdminView();
                } else if (currentUserId && !isAdmin) {
                    setupUserView();
                }
            });

            socket.on('chatList', renderChatRoomList);
            socket.on('roomDetails', ({ messages, isClosed }) => {
                isCurrentChatLocked = isClosed;
                renderMessages(messages);
                if(!isAdmin) {
                    updateUserMessageInputLock();
                } else {
                    updateAdminControls(true && currentRoomId !== ADMIN_ONLY_ROOM_ID);
                    updateLockUI();
                }
            });
            
            socket.on('newMessage', (message) => {
                const isScrolledToBottom = messagesContainer.scrollHeight - messagesContainer.clientHeight <= messagesContainer.scrollTop + 5;
                
                if (message.roomId === currentRoomId) {
                    appendMessage(message);
                    if (isScrolledToBottom) scrollToBottom();
                }
                
                if (message.senderId === (isAdmin ? 'admin' : currentUserId)) {
                    showSendingState(false);
                }
                
                const shouldNotify = (!isAdmin && message.isAdmin) || (isAdmin && !message.isAdmin && message.roomId !== ADMIN_ONLY_ROOM_ID);

                if (shouldNotify) {
                    if (document.hidden) {
                        const notificationTitle = message.isAdmin ? `Tin nhắn từ Quản trị viên` : `Tin nhắn mới từ ${message.displayName}`;
                        if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                            navigator.serviceWorker.controller.postMessage({
                                type: 'SHOW_NOTIFICATION',
                                payload: {
                                    title: notificationTitle,
                                    body: message.text,
                                    url: `${window.location.origin}/?roomId=${message.roomId}`,
                                    tag: message.roomId
                                }
                            });
                        }
                        document.title = `(Mới) ${notificationTitle}`;
                    } else if (message.roomId === currentRoomId) {
                        playNewMessageSound();
                    }
                }
            });

            socket.on('chat:locked', ({ roomId, isLocked }) => {
                if(currentRoomId === roomId) {
                   isCurrentChatLocked = isLocked;
                   if (!isAdmin) {
                       updateUserMessageInputLock();
                   } else {
                       updateLockUI();
                   }
                }
                const roomItem = document.querySelector(`#chat-list-container > div[data-room-id="${roomId}"]`);
                if(roomItem) {
                    const lockIconSvg = `<svg class="w-4 h-4 text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 1a4.5 4.5 0 00-4.5 4.5V9H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-.5V5.5A4.5 4.5 0 0010 1zm3 8V5.5a3 3 0 10-6 0V9h6z" clip-rule="evenodd" /></svg>`;
                    const lockIconContainer = roomItem.querySelector('.lock-icon-container');
                    if(isLocked) {
                        roomItem.classList.add('opacity-60');
                        if(lockIconContainer) lockIconContainer.innerHTML = lockIconSvg;
                    } else {
                        roomItem.classList.remove('opacity-60');
                         if(lockIconContainer) lockIconContainer.innerHTML = '';
                    }
                }
            });

            socket.on('messageDeleted', (messageId) => {
                const messageElement = document.getElementById('message-' + messageId);
                if (messageElement) {
                    messageElement.classList.add('opacity-0', 'transition-opacity', 'duration-300');
                    setTimeout(() => {
                        messageElement.remove();
                    }, 300);
                }
            });

            socket.on('conversationDeleted', (deletedRoomId) => {
                if (isAdmin) {
                    const roomItem = document.querySelector(`#chat-list-container > div[data-room-id="${deletedRoomId}"]`);
                    if (roomItem) {
                        roomItem.remove();
                    }
                    if (currentRoomId === deletedRoomId) {
                       resetChatWindow();
                    }
                    showToastNotification({ title: "Thành công", text: "Đã xóa cuộc hội thoại." }, 'success');
                }
            });

            socket.on('chatEndedByAdmin', () => {
                if (!isAdmin) {
                    messageInput.disabled = true;
                    sendMessageButton.disabled = true;
                    messageInput.placeholder = "Cuộc trò chuyện đã kết thúc.";
                    let endNotice = document.getElementById('end-notice');
                    if (!endNotice) {
                         endNotice = document.createElement('p');
                         endNotice.id = 'end-notice';
                         endNotice.className = 'text-center text-sm text-red-600 pb-2';
                         messageFooter.prepend(endNotice);
                    }
                    endNotice.textContent = 'Quản trị viên đã kết thúc cuộc trò chuyện này. Vui lòng tải lại trang để bắt đầu cuộc trò chuyện mới.';
                    userLogoutButton.textContent = "Bắt đầu lại";
                }
            });

            socket.on('chatError', (errorMessage) => {
                showToastNotification({ title: "Lỗi", text: errorMessage }, 'error');
                showSendingState(false);
            });

            socket.on('admin:list:update', (admins) => {
                const adminListUl = document.getElementById('online-admins-list');
                adminListUl.innerHTML = '';
                if (admins.length > 0) {
                    admins.forEach(admin => {
                        const li = document.createElement('li');
                        li.className = 'text-sm flex items-center';
                        li.innerHTML = `
                            <span class="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"></span>
                            <span class="font-medium text-gray-800">${admin.email}</span>
                        `;
                        adminListUl.appendChild(li);
                    });
                } else {
                    adminListUl.innerHTML = '<li class="text-xs text-gray-500 italic">Không có ai đang online.</li>';
                }
            });
        }
        function renderChatRoomList(rooms) {
            chatListContainer.innerHTML = '';
            if (rooms.length === 0) {
                chatListContainer.innerHTML = `<p class="p-4 text-center text-gray-500">Chưa có cuộc trò chuyện nào.</p>`;
            } else {
                rooms.forEach(room => renderChatRoomItem(room));
            }
        }
		function renderChatRoomItem(room) {
			const item = document.createElement('div');
			item.className = `p-4 border-b border-gray-200 cursor-pointer hover:bg-[#f5f1e9] transition ${room._id === currentRoomId ? 'bg-[#e6dacb]' : ''}`;
			if(room.isClosed) item.classList.add('opacity-60');
			if(room.isSpecial) item.classList.add('bg-yellow-50'); 
			item.dataset.roomId = room._id;
			const lastMessageTime = room.timestamp ? new Date(room.timestamp).toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' }) : '';
			item.innerHTML = `
				<div class="flex justify-between items-center">
					<p class="font-bold text-sm truncate text-[#6B4F4F]">${room.displayName || 'Sư huynh ẩn danh'}</p>
					<p class="text-xs text-gray-500">${lastMessageTime}</p>
				</div>
				<div class="flex justify-between items-start mt-1">
					<p class="text-sm text-gray-600 truncate pr-2">${room.lastMessage || '...'}</p>
					<div class="flex items-center space-x-2 flex-shrink-0">
					   <span class="lock-icon-container">
						   ${!room.isSpecial && room.isClosed ? `<svg class="w-4 h-4 text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 1a4.5 4.5 0 00-4.5 4.5V9H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-.5V5.5A4.5 4.5 0 0010 1zm3 8V5.5a3 3 0 10-6 0V9h6z" clip-rule="evenodd" /></svg>` : ''}
					   </span>
					   ${!room.isSpecial && room.hasUnreadAdmin ? '<span class="w-3 h-3 bg-red-500 rounded-full"></span>' : ''}
					</div>
				</div>
			`;
			item.addEventListener('click', () => {
				currentRoomId = room._id;
				isCurrentChatLocked = room.isClosed;
				socket.emit('admin:viewRoom', room._id);
				chatHeaderTitle.textContent = `${room.displayName || 'Sư huynh ẩn danh'}`;
				messageFooter.classList.remove('hidden');
				document.querySelectorAll('#chat-list-container > div').forEach(el => {
					el.classList.toggle('bg-[#e6dacb]', el.dataset.roomId === room._id);
				});
				
				// --- THÊM DÒNG NÀY ĐỂ XỬ LÝ NÚT BACK ---
				history.pushState({ view: 'chat', roomId: room._id }, '', `#${room._id}`);
				// ------------------------------------

				if (window.innerWidth < 768) {
					showChatWindow();
				}
			});
			chatListContainer.appendChild(item);
		}
        function renderMessages(messages) {
            messagesDiv.innerHTML = '';
            if (messages.length === 0) {
                adminPlaceholder.classList.toggle('hidden', !isAdmin || !currentRoomId);
                placeholder.classList.toggle('hidden', isAdmin || messages.length > 0);
            } else {
                placeholder.classList.add('hidden');
                adminPlaceholder.classList.add('hidden');
                messages.forEach(appendMessage);
            }
            scrollToBottom();
        }
		messageForm.addEventListener('submit', async e => {
            e.preventDefault();
            const text = messageInput.value.trim();
            
            // 1. CẬP NHẬT ĐIỀU KIỆN: Cho phép gửi nếu có Text HOẶC có Ảnh
            // (Code cũ chỉ kiểm tra !text)
            if ((!text && !selectedImageBase64) || !currentRoomId || !socket) {
                showToastNotification({ title: "Thông báo", text: "Vui lòng nhập nội dung hoặc chọn ảnh để gửi." }, 'error');
                return;
            }

            showSendingState(true);
            
            // Logic xác định tên người gửi (Giữ nguyên của code gốc)
            let senderDisplayName;
            if (isAdmin) {
                senderDisplayName = (currentRoomId === ADMIN_ONLY_ROOM_ID) ? adminEmail : adminDisplayName;
            } else {
                senderDisplayName = displayName;
            }

            // 2. CẬP NHẬT PAYLOAD: Thêm trường image
            socket.emit('sendMessage', {
                roomId: currentRoomId,
                senderId: isAdmin ? 'admin' : currentUserId,
                text: text,
                image: selectedImageBase64, // <--- THÊM DÒNG NÀY
                isAdmin: isAdmin,
                displayName: senderDisplayName
            }, (response) => {
                showSendingState(false);
                
                // 3. XỬ LÝ KẾT QUẢ (Giữ showToastNotification và thêm logic reset ảnh)
                if (response && response.status === 'error') {
                    showToastNotification({ title: "Lỗi gửi tin nhắn", text: response.message }, 'error');
                } else {
                    // Reset ô nhập liệu văn bản
                    messageInput.value = '';
                    
                    // --- THÊM: Reset phần ảnh sau khi gửi thành công ---
                    selectedImageBase64 = null;
                    imageInput.value = ''; // Xóa file trong thẻ input
                    imagePreviewContainer.style.display = 'none'; // Ẩn khung preview
                }
            });
        });
        function appendMessage(msg) {
            if (document.getElementById('message-' + msg._id)) {
                return;
            }

            placeholder.classList.add('hidden');
            adminPlaceholder.classList.add('hidden');
            const wrapper = document.createElement('div');
            wrapper.id = 'message-' + msg._id;
            const bubble = document.createElement('div');
            const time = document.createElement('div');
            const nameSpan = document.createElement('div');
            const messageContentDiv = document.createElement('div');
			
			messageContentDiv.className = 'whitespace-pre-wrap leading-relaxed break-words text-sm md:text-base mt-1';
			
            wrapper.classList.add('flex', 'flex-col', 'w-full');
            bubble.classList.add('max-w-[85%]', 'sm:max-w-md', 'px-4', 'py-2', 'rounded-2xl', 'break-words', 'relative', 'group');
            time.classList.add('text-xs', 'text-gray-500', 'mt-1');
            nameSpan.classList.add('font-bold', 'text-xs', 'block', 'mb-1');

            const msgDate = msg.timestamp ? new Date(msg.timestamp) : new Date();
            time.textContent = msgDate.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });

            if (msg.isAdmin) {
                wrapper.classList.add('items-end');
                bubble.classList.add('bg-[#6B4F4F]', 'text-white', 'shadow-md');
                time.classList.add('text-right');
                // Tên hiển thị (displayName) được gửi từ server sẽ được dùng ở đây
                nameSpan.innerHTML = `<svg class="w-4 h-4 inline-block mr-1 text-yellow-300" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg> ${msg.displayName || 'Quản trị viên'}`;
                nameSpan.classList.add('text-yellow-200');
            } else {
                wrapper.classList.add('items-start');
                bubble.classList.add('bg-white', 'shadow-sm');
                time.classList.add('text-left');
                nameSpan.textContent = msg.displayName || 'Sư Huynh';
                nameSpan.classList.add('text-gray-900');
            }
            messageContentDiv.innerHTML = linkify(msg.text, msg.isAdmin);
            bubble.appendChild(nameSpan);
			if (msg.image) {
			                const imgElement = document.createElement('img');
			                imgElement.src = msg.image;
			                
			                // Thêm class css
			                imgElement.className = 'chat-image mt-2 rounded-lg cursor-pointer border border-gray-200 hover:opacity-90 transition-opacity';
			                imgElement.style.maxWidth = '200px'; // Giới hạn chiều rộng ảnh nhỏ trong khung chat
			                imgElement.style.maxHeight = '200px'; // Giới hạn chiều cao
			
			                // Sự kiện bấm vào ảnh để phóng to
			                imgElement.onclick = (e) => {
			                    e.stopPropagation(); // Quan trọng: Ngăn chặn click lan ra ngoài
			                    const modal = document.getElementById('image-modal');
			                    const fullImg = document.getElementById('full-size-image');
			                    
			                    // Reset src trước khi gán mới để tránh hiện ảnh cũ trong tíc tắc
			                    fullImg.src = ''; 
			                    fullImg.src = msg.image;
			                    
			                    modal.classList.remove('hidden');
			                };
			                
			                bubble.appendChild(imgElement);
			}
            bubble.appendChild(messageContentDiv);
            wrapper.appendChild(bubble);
            wrapper.appendChild(time);
            messagesDiv.appendChild(wrapper);

            if (isAdmin && currentRoomId) {
                const deleteButton = document.createElement('button');
                deleteButton.innerHTML = `<svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>`;

                const positionClass = 'absolute -top-1.5 ' + (msg.isAdmin ? '-left-1.5' : '-right-1.5');
                deleteButton.className = `${positionClass} bg-red-500 text-white rounded-full p-0.5 opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer focus:outline-none`;

                deleteButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    socket.emit('admin:deleteMessage', { messageId: msg._id, roomId: currentRoomId });
                });
                bubble.appendChild(deleteButton);
            }
        }

        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function updateAdminControls(show) {
            const isUserRoom = show && currentRoomId !== ADMIN_ONLY_ROOM_ID;
            lockChatButton.classList.toggle('hidden', !isUserRoom);
            deleteConversationButton.classList.toggle('hidden', !isUserRoom);
        }

        lockChatButton.addEventListener('click', () => {
            if (!isAdmin || !currentRoomId || currentRoomId === ADMIN_ONLY_ROOM_ID) return;
            socket.emit('admin:toggleLock', { roomId: currentRoomId, isLocked: !isCurrentChatLocked });
        });

        deleteConversationButton.addEventListener('click', () => {
            if (!isAdmin || !currentRoomId || currentRoomId === ADMIN_ONLY_ROOM_ID) return;
            showCustomConfirmationModal({
                title: "Xác nhận Xóa",
                message: "Bạn có chắc chắn muốn xóa toàn bộ cuộc hội thoại này không? Hành động này không thể hoàn tác.",
                confirmText: "Xác nhận Xóa",
                confirmClass: "bg-red-600",
                onConfirm: () => {
                    socket.emit('admin:deleteConversation', { roomId: currentRoomId });
                }
            });
        });

        function updateLockUI() {
            if (isCurrentChatLocked) {
                lockChatText.textContent = 'Mở khoá';
                lockChatButton.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                lockChatButton.classList.add('bg-green-500', 'hover:bg-green-600');
                lockIcon.classList.add('hidden');
                unlockIcon.classList.remove('hidden');
            } else {
                lockChatText.textContent = 'Khoá';
                lockChatButton.classList.remove('bg-green-500', 'hover:bg-green-600');
                lockChatButton.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                unlockIcon.classList.add('hidden');
                lockIcon.classList.remove('hidden');
            }
        }
        function updateUserMessageInputLock() {
            let lockNotice = document.getElementById('lock-notice');
            if (isCurrentChatLocked) {
                messageInput.disabled = true;
                sendMessageButton.disabled = true;
                messageInput.placeholder = 'Cuộc trò chuyện này đã bị khoá.';
                if (!lockNotice) {
                    lockNotice = document.createElement('p');
                    lockNotice.id = 'lock-notice';
                    lockNotice.className = 'text-center text-xs text-red-600 pb-2';
                    messageFooter.prepend(lockNotice);
                }
                lockNotice.textContent = 'Quản trị viên đã khoá cuộc trò chuyện này.';
            } else {
                messageInput.disabled = false;
                sendMessageButton.disabled = false;
                messageInput.placeholder = 'Nhập câu hỏi của bạn...';
                if (lockNotice) lockNotice.remove();
            }
        }
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                document.title = originalTitle;
                updateFavicon(false);
            }
        });

        window.addEventListener('offline', () => {
            showToastNotification({ title: "Mất kết nối", text: "Bạn đang ngoại tuyến. Vui lòng kiểm tra kết nối mạng của bạn." }, 'error');
            messageInput.disabled = true;
            sendMessageButton.disabled = true;
        });

        window.addEventListener('online', () => {
            showToastNotification({ title: "Đã kết nối lại", text: "Kết nối mạng đã được khôi phục." }, 'success');
            if (!isCurrentChatLocked && !document.getElementById('end-notice')) {
                messageInput.disabled = false;
                sendMessageButton.disabled = false;
            }
        });

        function autoInitialize() {
            const adminToken = localStorage.getItem('adminToken');
            displayName = localStorage.getItem('chatDisplayName');
            adminDisplayName = localStorage.getItem('adminDisplayName'); 
            adminEmail = localStorage.getItem('adminEmail');
            currentUserId = localStorage.getItem('chatUserId');

            if (displayName) displayNameInput.value = displayName;

            if (adminToken) {
                isAdmin = true;
                initializeSocketConnection();
                showScreen(chatInterface);
            } else if (currentUserId) {
                isAdmin = false;
                initializeSocketConnection();
                showScreen(chatInterface);
            } else {
                showScreen(welcomeScreen);
            }
        }
        autoInitialize();

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
		
		// --- XỬ LÝ NÚT BACK CỦA ĐIỆN THOẠI ---
		window.addEventListener('popstate', (event) => {
			// Chỉ xử lý khi người dùng là admin và đang ở màn hình mobile
			if (isAdmin && window.innerWidth < 768) {
				const isChatWindowVisible = !chatWindowPanel.classList.contains('hidden');
				// Nếu đang xem cửa sổ chat, bấm Back sẽ quay lại danh sách
				if (isChatWindowVisible) {
					showChatList(); // Quay lại danh sách chat
					return; // Dừng xử lý tại đây
				}
			}

			// Xử lý nhấn Back 2 lần để thoát
			if (backButtonPressedOnce) {
				window.close(); // Lần nhấn thứ 2, cho phép thoát
				return;
			}

			// Đây là lần nhấn đầu tiên
			backButtonPressedOnce = true;
			showToastNotification({ title: 'Thoát ứng dụng', text: 'Nhấn Back lần nữa để thoát.' });

			// Đặt lại cờ sau 2 giây
			setTimeout(() => {
				backButtonPressedOnce = false;
			}, 2000);

			// Ngăn chặn việc thoát ứng dụng ngay lần đầu bằng cách đẩy lại một trạng thái giả
			history.pushState(null, '', window.location.pathname);
		});
		// ------------------------------------
    </script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
	<div class="hidden bg-orange-500 hover:bg-orange-700"></div>
</body>
</html>







