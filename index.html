<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PHÁP MÔN TÂM LINH - KẾT NỐI CỘNG ĐỒNG</title>
	<link id="favicon" rel="icon" href="/favicon.ico" type="image/png">
	<link href="/dist/output.css" rel="stylesheet">
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="manifest" href="/manifest.json">
    <style>
        html, body { height: 100%; overflow: hidden; }
        body { font-family: 'Inter', sans-serif; }
        .scrollable-content::-webkit-scrollbar { width: 6px; }
        .scrollable-content::-webkit-scrollbar-track { background: #f1f1f1; }
        .scrollable-content::-webkit-scrollbar-thumb { background: #c19a6b; border-radius: 6px; }
        .scrollable-content::-webkit-scrollbar-thumb:hover { background: #a9885a; }
        .bg-pattern { background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23c19a6b' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"); }
        /* Style cho ảnh trong tin nhắn */
        .chat-image { max-width: 100%; border-radius: 8px; margin-top: 5px; cursor: pointer; border: 1px solid rgba(0,0,0,0.1); }
        .chat-image:hover { opacity: 0.9; }
        /* Preview ảnh trước khi gửi */
        #image-preview-container { position: absolute; bottom: 80px; left: 20px; right: 20px; background: white; padding: 10px; border-radius: 10px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); display: none; z-index: 10; }
        #image-preview { max-height: 150px; border-radius: 5px; display: block; margin: 0 auto; }
        #remove-image { position: absolute; top: 5px; right: 5px; background: red; color: white; border-radius: 50%; width: 24px; height: 24px; text-align: center; line-height: 24px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body class="bg-[#fffbbe] antialiased">
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm mx-4">
            <h3 id="confirmation-title" class="text-lg font-bold text-gray-800">Xác nhận</h3>
            <p id="confirmation-message" class="text-gray-600 mt-2">Nội dung xác nhận.</p>
            <div class="mt-6 flex justify-end space-x-4">
                <button id="confirm-cancel-button" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Hủy bỏ</button>
                <button id="confirm-action-button" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Xác nhận</button>
            </div>
        </div>
    </div>
    
    <div id="image-modal" class="hidden fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-[60]" onclick="this.classList.add('hidden')">
        <img id="full-size-image" src="" class="max-w-full max-h-full object-contain p-2">
    </div>

    <div id="install-prompt-container" class="hidden fixed bottom-0 left-0 right-0 bg-[#6B4F4F] text-white p-4 flex items-center justify-between z-50 shadow-lg">
        <div class="flex items-center">
            <svg class="w-8 h-8 mr-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
            <div><p class="font-bold text-sm">Cài đặt ứng dụng</p></div>
        </div>
        <div class="flex items-center space-x-3">
            <button id="install-button" class="px-4 py-2 bg-white text-[#6B4F4F] rounded-lg font-bold text-sm hover:bg-gray-100">Cài đặt</button>
            <button id="close-install-prompt" class="text-white hover:text-gray-200"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></button>
        </div>
    </div>

    <div id="toast-container" class="fixed top-5 right-5 z-40 w-full max-w-xs space-y-2"></div>

    <div id="app" class="w-full h-full flex flex-col">
        <div id="welcome-screen" class="w-full h-full flex items-center justify-center bg-pattern p-4">
             <div class="text-center p-6 bg-white/80 backdrop-blur-sm rounded-2xl shadow-2xl border border-gray-200 mx-auto max-w-md">
                <img src="logo.png" alt="Logo" class="w-20 h-20 mx-auto mb-4 object-contain" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
                <div style="display:none;" class="w-20 h-20 mx-auto mb-4 bg-gray-200 rounded-full flex items-center justify-center text-gray-500">Logo</div>
                <h1 class="text-2xl font-bold text-[#6B4F4F] leading-tight">PHÁP MÔN TÂM LINH<br><span class="text-2xl">Chia Sẻ & Kết Nối</span></h1>
                <p class="text-gray-500 mt-2 text-sm">https://chat.pmtl.site</p>
                <div class="mt-6 w-full max-w-xs mx-auto">
                    <label class="block text-sm font-medium text-gray-700 mb-1 text-left">Tên hiển thị</label>
                    <input id="display-name-input" type="text" placeholder="Ví dụ: Sư Huynh An Lạc" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-[#c19a6b] focus:border-[#c19a6b]">
                </div>
                <div class="mt-4 space-y-3 flex flex-col items-center">
                    <button id="start-chat-button" class="w-full max-w-xs bg-[#c19a6b] text-white font-bold py-3 px-6 rounded-lg hover:bg-[#a9885a]">Bắt đầu trò chuyện</button>
                </div>
                <div class="mt-8 text-center"><button id="admin-login-prompt-button" class="text-xs text-gray-500 hover:text-[#c19a6b] hover:underline">Đăng nhập Quản trị viên</button></div>
             </div>
        </div>

        <div id="login-screen" class="hidden w-full h-full items-center justify-center bg-pattern p-4">
             <div class="w-full max-w-sm p-8 bg-white/80 backdrop-blur-sm rounded-2xl shadow-2xl border border-gray-200">
                <div class="text-center mb-8"><h1 class="text-3xl font-bold text-[#6B4F4F]">Đăng Nhập Quản Trị</h1></div>
                <form id="login-form">
					<div class="mb-4"><label>Email</label><input type="email" id="email" required class="w-full px-4 py-2 border rounded-lg"></div>
					<div class="mb-6"><label>Mật khẩu</label><input type="password" id="password" required class="w-full px-4 py-2 border rounded-lg"></div>
                    <button type="submit" class="w-full bg-[#c19a6b] text-white font-bold py-3 rounded-lg hover:bg-[#a9885a]">Đăng Nhập</button>
                    <p id="login-error" class="text-red-500 text-sm mt-4 text-center"></p>
                    <button type="button" id="back-to-welcome-button" class="w-full mt-4 text-sm text-gray-600 hover:text-[#c19a6b]">Quay lại</button>
                </form>
            </div>
        </div>

        <div id="chat-interface" class="hidden h-full w-full flex-grow flex md:flex-row">
            <div id="chat-list-panel" class="hidden md:flex flex-col w-full h-full md:w-1/3 lg:w-1/4 bg-white border-r border-gray-200 overflow-hidden">
                <div class="p-4 border-b border-gray-200 flex items-center justify-between flex-shrink-0">
                    <div><h2 class="text-xl font-bold text-[#6B4F4F]">DANH SÁCH</h2></div>
                </div>
                <div id="online-admins-panel" class="hidden p-4 border-b border-gray-200 flex-shrink-0 bg-gray-50">
                    <h3 class="text-sm font-bold text-[#6B4F4F] mb-2">QUẢN TRỊ VIÊN</h3>
                    <ul id="online-admins-list" class="space-y-2"></ul>
                </div>
                <div id="chat-list-container" class="flex-grow overflow-y-auto scrollable-content"></div>
                <div class="p-2 border-t border-gray-200"><button id="logout-button" class="w-full text-sm text-gray-600 hover:bg-gray-200 p-2 rounded-md">Đăng xuất</button></div>
            </div>

            <div id="chat-window-panel" class="hidden md:flex flex-col w-full h-full bg-[#F5F1E9] relative">
                <header class="flex-shrink-0 bg-white/80 backdrop-blur-sm shadow-md p-3 flex items-center justify-between border-b border-gray-200 z-20">
                    <div class="flex items-center flex-1 min-w-0">
                        <button id="open-chat-list-button" class="md:hidden mr-2 text-gray-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg></button>
                        <h1 id="chat-header-title" class="text-lg font-bold text-[#6B4F4F] ml-2 truncate">Hỗ Trợ Trực Tuyến</h1>
                    </div>
                    <div class="flex items-center space-x-2 flex-shrink-0 ml-2">
                         <button id="delete-conversation-button" class="hidden bg-red-600 text-white font-bold py-2 px-3 rounded-lg hover:bg-red-700 text-xs">Xóa</button>
                         <button id="lock-chat-button" class="hidden bg-yellow-500 text-white font-bold py-2 px-3 rounded-lg hover:bg-yellow-600 text-xs"><span id="lock-chat-text">Khoá</span></button>
                         <button id="user-logout-button" class="hidden md:block text-sm text-gray-600 hover:text-[#c19a6b]">Thoát</button>
                    </div>
                </header>
                
                <main id="messages-container" class="flex-grow p-4 md:p-6 overflow-y-auto scrollable-content z-0">
                    <div id="messages" class="space-y-4">
                        <div id="placeholder" class="text-center text-gray-500 mt-10"><p>Chào mừng bạn!</p><p class="text-sm">Hãy đặt câu hỏi của bạn.</p></div>
                        <div id="admin-placeholder" class="hidden mt-4 text-center text-sm">Vui lòng chọn cuộc trò chuyện.</div>
                    </div>
                </main>

                <div id="image-preview-container">
                    <div id="remove-image">×</div>
                    <img id="image-preview" src="" alt="Preview">
                </div>

                <footer id="message-footer" class="flex-shrink-0 p-3 bg-white/80 backdrop-blur-sm border-t border-gray-200 z-20">
                    <form id="message-form" class="flex items-center space-x-2">
                        <label for="image-input" class="cursor-pointer text-gray-500 hover:text-[#c19a6b] p-2">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
                            </svg>
                        </label>
                        <input type="file" id="image-input" accept="image/*" class="hidden">
                        
                        <input id="message-input" type="text" placeholder="Nhập tin nhắn..." autocomplete="off" class="flex-grow px-4 py-3 border border-gray-300 rounded-full focus:ring-[#c19a6b] focus:border-[#c19a6b] disabled:bg-gray-200">
                        <button type="submit" id="send-message-button" class="bg-[#c19a6b] text-white rounded-full p-3 hover:bg-[#a9885a] disabled:bg-gray-400 flex items-center justify-center">
                            <svg id="send-icon" class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"></path></svg>
                            <div id="loading-spinner" class="hidden animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                        </button>
                    </form>
                </footer>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const BACKEND_URL = "https://chat-t1ar.onrender.com"; 
        const VAPID_PUBLIC_KEY = "BLR3ESERJvSd663nWEkEVoQHkfIk6V0akO8_lVv8Tl4ATq3TNJc2wZQQUYajbRUN0rXreHPDA5As_OMOMN8e4Ms";
        const ADMIN_ONLY_ROOM_ID = 'admins_only_chat';

        // --- DOM ---
        const socket = io(BACKEND_URL, { reconnection: true });
		// Các biến DOM cơ bản
        const appDiv = document.getElementById('app');
        const welcomeScreen = document.getElementById('welcome-screen');
        const loginScreen = document.getElementById('login-screen');
        const chatInterface = document.getElementById('chat-interface');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const messagesDiv = document.getElementById('messages');
        const imageInput = document.getElementById('image-input');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        const removeImageBtn = document.getElementById('remove-image');
        const imageModal = document.getElementById('image-modal');
        const fullSizeImage = document.getElementById('full-size-image');

        // --- CÁC NÚT ADMIN (Mới thêm lại) ---
        const deleteConversationButton = document.getElementById('delete-conversation-button');
        const lockChatButton = document.getElementById('lock-chat-button');
        const lockChatText = document.getElementById('lock-chat-text');

        // State
        let isAdmin = false;
        let currentUserId = localStorage.getItem('chatUserId');
        let displayName = localStorage.getItem('chatDisplayName');
        let adminDisplayName = localStorage.getItem('adminDisplayName'); 
        let adminEmail = localStorage.getItem('adminEmail');
        let currentRoomId = null;
        let selectedImageBase64 = null;
        let isCurrentChatLocked = false;
        
        // --- XỬ LÝ ẢNH (Giữ nguyên) ---
        imageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    let width = img.width; let height = img.height;
                    const maxSize = 800;
                    if (width > height) { if (width > maxSize) { height *= maxSize / width; width = maxSize; } } 
                    else { if (height > maxSize) { width *= maxSize / height; height = maxSize; } }
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    selectedImageBase64 = canvas.toDataURL('image/jpeg', 0.7);
                    imagePreview.src = selectedImageBase64;
                    imagePreviewContainer.style.display = 'block';
                }
                img.src = event.target.result;
            }
            reader.readAsDataURL(file);
        });

        removeImageBtn.addEventListener('click', () => {
            selectedImageBase64 = null;
            imageInput.value = '';
            imagePreviewContainer.style.display = 'none';
        });

        // --- CORE FUNCTIONS ---
        function linkify(text) {
            const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
            return text.replace(urlRegex, url => `<a href="${url}" target="_blank" class="underline text-[#c19a6b] hover:text-[#a9885a] font-bold break-all">${url}</a>`);
        }
        
        function showScreen(screen) {
            [welcomeScreen, loginScreen, chatInterface].forEach(s => s.classList.add('hidden'));
            screen.classList.remove('hidden');
            screen.classList.add('flex');
        }

        // --- ADMIN LOGIC (Xóa / Khóa) ---
        function updateAdminControls(show) {
            if (!isAdmin) {
                deleteConversationButton.classList.add('hidden');
                lockChatButton.classList.add('hidden');
                return;
            }
            const isUserRoom = show && currentRoomId !== ADMIN_ONLY_ROOM_ID;
            if (isUserRoom) {
                deleteConversationButton.classList.remove('hidden');
                lockChatButton.classList.remove('hidden');
            } else {
                deleteConversationButton.classList.add('hidden');
                lockChatButton.classList.add('hidden');
            }
        }

        function updateLockUI() {
            if (isCurrentChatLocked) {
                lockChatText.textContent = 'Mở khoá';
                lockChatButton.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                lockChatButton.classList.add('bg-green-500', 'hover:bg-green-600');
                messageInput.disabled = true;
                messageInput.placeholder = "Đã bị khóa";
            } else {
                lockChatText.textContent = 'Khoá';
                lockChatButton.classList.remove('bg-green-500', 'hover:bg-green-600');
                lockChatButton.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                messageInput.disabled = false;
                messageInput.placeholder = "Nhập tin nhắn...";
            }
        }

        deleteConversationButton.addEventListener('click', () => {
            if(confirm("Bạn có chắc chắn muốn XÓA vĩnh viễn cuộc hội thoại này?")) {
                socket.emit('admin:deleteConversation', { roomId: currentRoomId });
            }
        });

        lockChatButton.addEventListener('click', () => {
             socket.emit('admin:toggleLock', { roomId: currentRoomId, isLocked: !isCurrentChatLocked });
        });


        // --- SOCKET & CHAT LOGIC ---
        function renderMessages(messages) {
            messagesDiv.innerHTML = '';
            if (messages.length === 0) {
                document.getElementById('placeholder').classList.remove('hidden');
            } else {
                document.getElementById('placeholder').classList.add('hidden');
                document.getElementById('admin-placeholder').classList.add('hidden');
                messages.forEach(appendMessage);
            }
            scrollToBottom();
        }

        function appendMessage(msg) {
            if (document.getElementById('message-' + msg._id)) return;

            const wrapper = document.createElement('div');
            wrapper.id = 'message-' + msg._id;
            wrapper.className = `flex flex-col w-full ${msg.isAdmin ? 'items-end' : 'items-start'}`;

            const bubble = document.createElement('div');
            bubble.className = `max-w-[85%] sm:max-w-md px-4 py-2 rounded-2xl break-words relative group ${msg.isAdmin ? 'bg-[#6B4F4F] text-white shadow-md' : 'bg-white shadow-sm'}`;

            const nameSpan = document.createElement('div');
            nameSpan.className = `font-bold text-xs block mb-1 ${msg.isAdmin ? 'text-yellow-200' : 'text-gray-900'}`;
            nameSpan.innerHTML = msg.isAdmin ? `★ ${msg.displayName || 'Quản trị'}` : (msg.displayName || 'Sư Huynh');

            const contentDiv = document.createElement('div');
            if (msg.text) contentDiv.innerHTML = linkify(msg.text);
            
            bubble.appendChild(nameSpan);
            bubble.appendChild(contentDiv);

            if (msg.image) {
                const imgElement = document.createElement('img');
                imgElement.src = msg.image;
                imgElement.className = 'chat-image';
                imgElement.onclick = () => {
                    fullSizeImage.src = msg.image;
                    imageModal.classList.remove('hidden');
                };
                bubble.appendChild(imgElement);
            }

            // Xóa tin nhắn lẻ (Admin only)
            if (isAdmin && currentRoomId) {
                const deleteMsgBtn = document.createElement('button');
                deleteMsgBtn.innerHTML = '×';
                const pos = msg.isAdmin ? '-left-2' : '-right-2';
                deleteMsgBtn.className = `absolute -top-2 ${pos} bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition shadow-sm`;
                deleteMsgBtn.onclick = (e) => { e.stopPropagation(); if(confirm('Xóa tin này?')) socket.emit('admin:deleteMessage', { messageId: msg._id, roomId: currentRoomId }); };
                bubble.appendChild(deleteMsgBtn);
            }

            const time = document.createElement('div');
            time.className = `text-xs text-gray-500 mt-1 ${msg.isAdmin ? 'text-right' : 'text-left'}`;
            time.textContent = new Date(msg.timestamp).toLocaleTimeString('vi-VN', {hour:'2-digit', minute:'2-digit'});

            wrapper.appendChild(bubble);
            wrapper.appendChild(time);
            messagesDiv.appendChild(wrapper);
        }

        function scrollToBottom() { document.getElementById('messages-container').scrollTop = 99999; }

        messageForm.addEventListener('submit', async e => {
            e.preventDefault();
            const text = messageInput.value.trim();
            if ((!text && !selectedImageBase64) || !currentRoomId) return;
            if (isCurrentChatLocked && !isAdmin) { alert("Cuộc trò chuyện đã bị khóa"); return; }

            document.getElementById('send-message-button').disabled = true;
            let senderName = isAdmin ? ((currentRoomId === ADMIN_ONLY_ROOM_ID) ? adminEmail : adminDisplayName) : displayName;

            socket.emit('sendMessage', {
                roomId: currentRoomId,
                senderId: isAdmin ? 'admin' : currentUserId,
                text: text,
                image: selectedImageBase64,
                isAdmin: isAdmin,
                displayName: senderName
            }, (response) => {
                document.getElementById('send-message-button').disabled = false;
                if (response && response.status === 'success') {
                    messageInput.value = '';
                    selectedImageBase64 = null;
                    imageInput.value = '';
                    imagePreviewContainer.style.display = 'none';
                } else {
                    alert("Lỗi: " + (response.message || "Không thể gửi tin."));
                }
            });
        });

        // --- EVENT HANDLERS ---
        document.getElementById('start-chat-button').addEventListener('click', async () => {
            try { if (typeof Tone !== 'undefined' && Tone.context.state !== 'running') await Tone.start(); } catch(e){}
            displayName = document.getElementById('display-name-input').value.trim() || 'Sư Huynh Vô Danh';
            localStorage.setItem('chatDisplayName', displayName);
            if (!currentUserId) {
                currentUserId = 'user_' + Date.now() + Math.random().toString(36).substring(2, 9);
                localStorage.setItem('chatUserId', currentUserId);
            }
            isAdmin = false;
            askPermissionAndSubscribe();
            showScreen(chatInterface);
            setupUserView();
        });

        document.getElementById('admin-login-prompt-button').addEventListener('click', () => showScreen(loginScreen));
        document.getElementById('login-form').addEventListener('submit', async e => {
            e.preventDefault();
            try {
                const res = await fetch(`${BACKEND_URL}/login`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({email: document.getElementById('email').value, password: document.getElementById('password').value})
                });
                if(!res.ok) throw new Error();
                const data = await res.json();
                localStorage.setItem('adminToken', data.token);
                localStorage.setItem('adminDisplayName', data.displayName);
                localStorage.setItem('adminEmail', data.email);
                adminDisplayName = data.displayName; adminEmail = data.email;
                isAdmin = true;
                setupAdminView();
                showScreen(chatInterface);
            } catch(e) { document.getElementById('login-error').textContent = 'Lỗi đăng nhập'; }
        });

        document.getElementById('logout-button').addEventListener('click', () => { localStorage.clear(); location.reload(); });
        document.getElementById('user-logout-button').addEventListener('click', () => { if(confirm("Thoát?")) { localStorage.clear(); location.reload(); }});
        
        document.getElementById('open-chat-list-button').addEventListener('click', () => {
            document.getElementById('chat-list-panel').classList.remove('hidden');
            document.getElementById('chat-window-panel').classList.add('hidden');
            document.getElementById('chat-window-panel').classList.remove('flex'); // Tắt flex để ẩn hẳn
        });

        function setupUserView() {
            document.getElementById('chat-list-panel').classList.add('hidden');
            document.getElementById('online-admins-panel').classList.add('hidden');
            
            const chatWindow = document.getElementById('chat-window-panel');
            chatWindow.classList.remove('hidden');
            chatWindow.classList.add('flex'); // Kích hoạt Flexbox
            
            document.getElementById('chat-header-title').textContent = displayName;
            currentRoomId = currentUserId;
            
            updateAdminControls(false); // Ẩn nút xóa với user
            socket.emit('user:join', { userId: currentUserId, displayName: displayName });
        }

        function setupAdminView() {
            document.getElementById('chat-list-panel').classList.remove('hidden', 'flex');
            document.getElementById('online-admins-panel').classList.remove('hidden');
            socket.emit('admin:join', { displayName: adminDisplayName, email: adminEmail });
            askPermissionAndSubscribe();
        }

        // --- SOCKET EVENTS ---
        socket.on('newMessage', msg => { if (msg.roomId === currentRoomId) { appendMessage(msg); scrollToBottom(); } });
        
        // Sửa lại logic click vào room để hiển thị đúng giao diện
        socket.on('chatList', rooms => {
            const container = document.getElementById('chat-list-container');
            container.innerHTML = '';
            rooms.forEach(room => {
                const div = document.createElement('div');
                div.className = `p-4 border-b hover:bg-gray-100 cursor-pointer ${room._id === currentRoomId ? 'bg-[#e6dacb]' : ''}`;
                if(room.isSpecial) div.classList.add('bg-yellow-50');
                if(room.hasUnreadAdmin) div.classList.add('font-bold'); // Highlight chưa đọc

                div.innerHTML = `
                    <div class="flex justify-between">
                        <p class="font-bold text-[#6B4F4F] ${room.isSpecial ? 'text-red-600' : ''}">${room.displayName}</p>
                        ${!room.isSpecial && room.hasUnreadAdmin ? '<span class="w-2 h-2 bg-red-500 rounded-full"></span>' : ''}
                    </div>
                    <p class="text-sm truncate text-gray-500">${room.lastMessage || '...'}</p>`;
                
                div.onclick = () => {
                    currentRoomId = room._id;
                    isCurrentChatLocked = room.isClosed;
                    document.getElementById('chat-header-title').textContent = room.displayName;
                    document.querySelectorAll('#chat-list-container > div').forEach(el => el.classList.remove('bg-[#e6dacb]'));
                    div.classList.add('bg-[#e6dacb]');
                    
                    socket.emit('admin:viewRoom', room._id);
                    
                    // Nếu là mobile thì chuyển màn hình
                    if(window.innerWidth < 768) {
                        document.getElementById('chat-list-panel').classList.add('hidden');
                        const chatWindow = document.getElementById('chat-window-panel');
                        chatWindow.classList.remove('hidden');
                        chatWindow.classList.add('flex');
                    }
                };
                container.appendChild(div);
            });
        });

        // Sửa: Thêm logic cập nhật nút Admin khi vào phòng
        socket.on('roomDetails', ({messages, isClosed}) => {
            isCurrentChatLocked = isClosed;
            renderMessages(messages);
            if(isAdmin) {
                updateAdminControls(true); // Hiện nút Xóa/Khóa
                updateLockUI();
            } else {
                updateAdminControls(false);
            }
        });

        socket.on('chat:locked', ({ roomId, isLocked }) => {
            if(currentRoomId === roomId) {
                isCurrentChatLocked = isLocked;
                if(isAdmin) updateLockUI();
                else {
                    if(isLocked) { messageInput.disabled=true; messageInput.placeholder="Đã bị khóa"; }
                    else { messageInput.disabled=false; messageInput.placeholder="Nhập tin nhắn..."; }
                }
            }
        });
        
        socket.on('messageDeleted', (id) => {
            const el = document.getElementById('message-'+id);
            if(el) el.remove();
        });

        socket.on('conversationDeleted', (id) => {
            if(isAdmin) {
                if(currentRoomId === id) { 
                    messagesDiv.innerHTML = ''; 
                    document.getElementById('admin-placeholder').classList.remove('hidden');
                    updateAdminControls(false);
                }
                // Xóa khỏi danh sách sẽ được cập nhật tự động qua socket chatList
            } else {
                alert("Cuộc hội thoại đã kết thúc.");
                location.reload();
            }
        });
        
        // Auto Login Check
        if(localStorage.getItem('adminToken')) { isAdmin=true; adminDisplayName=localStorage.getItem('adminDisplayName'); adminEmail=localStorage.getItem('adminEmail'); setupAdminView(); showScreen(chatInterface); }
        else if(localStorage.getItem('chatUserId')) { isAdmin=false; currentUserId=localStorage.getItem('chatUserId'); displayName=localStorage.getItem('chatDisplayName'); setupUserView(); showScreen(chatInterface); }

        // Web Push (Giữ nguyên)
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
            return outputArray;
        }
        async function askPermissionAndSubscribe() {
            if (!('serviceWorker' in navigator)) return;
            try {
                const reg = await navigator.serviceWorker.ready;
                let sub = await reg.pushManager.getSubscription();
                if (!sub) sub = await reg.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY) });
                const endpoint = isAdmin ? '/api/save-admin-subscription' : '/api/save-subscription';
                const body = isAdmin ? { subscription: sub } : { subscription: sub, roomId: currentUserId };
                await fetch(BACKEND_URL + endpoint, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) });
            } catch (e) { console.error(e); }
        }
    </script>
</body>
</html>





